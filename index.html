<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Today's Events</title>
  <style>
    body {
      background: 1e1e1e;
      color: white;
      font-family: sans-serif;
      padding: 30px;
      text-align: Left;
      font-size: 2em;
    }
    h2 {
      font-size: 1em;
      margin-top: .5em;
    }
    ul {
      list-style: none;
      padding-left: 0;
    }
    li {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="calendar-events">Loading...</div>

  <script>
    const apiKey = 'AIzaSyASL0wY0Mfra3XJOH7-OAqF61rWKTCLObk';

    const calendars = [
      {
        id: 'c_b41d9592e175651e08d8e261b18b9789f807fc2fd98906cdf6713a9339febe51@group.calendar.google.com',
        name: 'LES Building Calendar'
      },
      {
        id: 'c_2d6dd077d98f1d0eaaf873ffc779de4ad0572dbb64b1a815a15f4264786b15f8@group.calendar.google.com',
        name: 'LES Reservations'
      },
      {
        id: 'en.usa#holiday@group.v.calendar.google.com',
        name: 'Holidays in United States'
      },
      {
        id: 'c_d86a8ab1e4963c830ba22daa51368e924b50362cfb03f8c073b6896c9f6a3c88@group.calendar.google.com',
        name: ' '
      }
    ];

    const now = new Date();
    const startOfDay = new Date(now.setHours(0, 0, 0, 0)).toISOString();
    const endOfDay = new Date(now.setHours(23, 59, 59, 999)).toISOString();

    const eventContainer = document.getElementById('calendar-events');

    function fetchEvents() {
      eventContainer.innerHTML = '';

      Promise.all(calendars.map(calendar => {
        const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendar.id)}/events?key=${apiKey}&timeMin=${startOfDay}&timeMax=${endOfDay}&singleEvents=true&orderBy=startTime`;

        return fetch(url)
          .then(res => res.json())
          .then(data => ({ name: calendar.name, items: data.items || [] }))
          .catch(err => {
            console.error(`Error loading calendar ${calendar.name}`, err);
            return { name: calendar.name, items: [] };
          });
      }))
      .then(results => {
        results.forEach(({ name, items }) => {
          if (items.length === 0) return;

          const calHeader = document.createElement('h2');
          calHeader.textContent = name;
          eventContainer.appendChild(calHeader);

          const ul = document.createElement('ul');

          items.forEach(event => {
            const li = document.createElement('li');
            const start = new Date(event.start.dateTime || event.start.date);
            const end = new Date(event.end.dateTime || event.end.date);

            let label;

            const isAllDay = !event.start.dateTime;
            const isMidnightToMidnight = (
              start.getHours() === 0 &&
              start.getMinutes() === 0 &&
              end.getHours() === 0 &&
              end.getMinutes() === 0 &&
              (end.getTime() - start.getTime()) === 24 * 60 * 60 * 1000
            );

            const totalDays = Math.round((end - start) / (1000 * 60 * 60 * 24));
            const currentDay = Math.floor((now - start) / (1000 * 60 * 60 * 24)) + 1;

            if (isAllDay || isMidnightToMidnight) {
              label = 'All Day';
            } else if (totalDays > 1 && now >= start && now < end) {
              label = `Day ${currentDay} of ${totalDays}`;
            } else {
              label = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            li.textContent = `${label} â€” ${event.summary}`;
            ul.appendChild(li);
          });

          eventContainer.appendChild(ul);
        });
      });
    }

    fetchEvents();
    setInterval(fetchEvents, 300000); // refresh every 5 minutes
  </script>
</body>
</html>
